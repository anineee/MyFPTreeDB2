# 论文阅读与前期工作总结
姓名：陆俞因，廖婕， 陈文丰<br/>
学号：17343081，17343072，

---
## 前期工作

### 使用示意图展示普通文件IO方式(fwrite等)的流程，即进程与系统内核，磁盘之间的数据交换如何进行？为什么写入完成后要调用fsync？
![普通文件IO方式示意图](http://blog.chinaunix.net/attachment/201207/11/27105712_13419741441gpp.gif)

普通文件IO需要穿越多层，从进程写到系统内核，再从系统内核最终写到磁盘。

`fwrite()`是系统提供的最上层接口，作用是在用户进程空间开辟 **CLib buffer** ，将多次小数据量相邻写操作先从 **application buffer** 拷贝到 **CLib buffer** 缓存起来，如果此时进程终止，数据会丢失。此时可以调用`fclose()`主动将 **CLib buffer** 的数据刷新到磁盘介质上。

一种方式是调用`write()`，将数据从应用层中的 **CLib buffer** 的数据一次性拷贝到内核层中的 **page cache** ，此时会触发内核态/用户态的切换。数据到达 **page cache** 后由内核IO调度决定何时写入磁盘。另一种方式是调用`fflush()`将数据从 **CLib buffer** 拷贝到 **page cache** 中。

内核中pdflush不停监测脏页，判断是否要写回到磁盘中，并将需要写回的页提交到IO队列中，根据IO调度队列的调度策略决定何时写回。从IO队列出来后，进入驱动层，驱动层通过DMA将数据写入 **disk cache** 。由磁盘控制器决定何时将 **disk cache** 的数据写到磁盘介质上，或是通过调用`fsync()`主动将 **page cache** 中的数据刷新到磁盘上。

### 简述文件映射的方式如何操作文件。与普通IO区别？为什么写入完成后要调用msync？文件内容什么时候被载入内存？
常规文件操作为了提高读写效率和保护磁盘，使用了页缓存机制,即读文件时需要先将文件页从磁盘拷贝到 **page cache** 中，由于 **page cache** 处在内核空间，不能被用户进程直接寻址，所以还需要将 **page cache** 中数据页再次拷贝到内存对应的用户空间中。这样，通过了两次数据拷贝过程，才能完成进程对文件内容的获取任务。写操作也是一样，待写入的 **application buffer** 在内核空间不能直接访问，必须要先拷贝至内核空间对应的主存，再写回磁盘中（延迟写回），也是需要两次数据拷贝。

区别于普通IO，文件映射通过将一个文件或者其它对象映射到进程的地址空间，实现文件磁盘地址和进程虚拟地址空间中一段虚拟地址的一一对映关系。实现这样的映射关系后，进程就可以采用指针的方式读写操作这一段内存，而系统会自动回写脏页面到对应的文件磁盘上，即完成了对文件的操作。在之后访问数据时发现内存中并无数据而发起的缺页异常过程，可以通过已经建立好的映射关系，只使用一次数据拷贝，就从磁盘中将数据传入内存的用户空间中，供进程使用。
![文件映射示意图](https://images0.cnblogs.com/blog2015/571793/201507/200501092691998.png)

文件映射的实现过程可以分为三个阶段。

首先，进程在用户空间调用`mmap()`启动映射过程并在用户的虚拟地址空间创建一个新的虚拟映射区。

然后，在内核空间调用`mmap()`（不同于用户空间函数），实现文件物理地址和进程虚拟地址的一一映射关系。至此，没有将任何文件数据拷贝到内存。

最后，进程发起对这片映射空间的访问，引发缺页异常，确认无非法操作后，内核发起请求调页。先在交换缓存空间 **swap cache** 中寻找需要访问的内存页，如果没有则将文件内容从磁盘拷贝到物理内存。之后进程即可对这片主存进行读写操作，如果写操作改变了其内容，一定时间后系统会自动回写脏页面到对应磁盘地址，完成写入到文件的过程。修改过的脏页面并不会立即更新回文件中，而是有一段时间的延迟，可以调用`msync()`来强制同步, 将所写的内容立即保存到文件里了。

### 参考Intel的NVM模拟教程模拟NVM环境，用fio等工具测试模拟NVM的性能并与磁盘对比（关键步骤结果截图）。
在 Ubuntu 下配置，跳过内核配置、编译和安装步骤。

首先，通过`dmesg | grep BIOS-e820`命令查看测试机的内存情况,可见从地址0x100000000到地址0x23fffffff有4.25G空闲内存。

![内存情况](https://note.youdao.com/yws/api/personal/file/WEB4935acd0520cdde84801c7c450d551fa?method=getImage&version=40&cstk=oSXnNHLm)

然后，`sudo su`进入根模式后通过`gedit /etc/default/grub`修改内存配置，添加语句`memmap=4G!4G`表示从内存4G位置（!标识符后）开始，划分4G大小（!标识符前）内存空间为非易失性内存。

![gedit grub](https://note.youdao.com/yws/api/personal/file/WEB485fce0be5603bac9f5c000f69da0f52?method=getImage&version=41&cstk=oSXnNHLm)
